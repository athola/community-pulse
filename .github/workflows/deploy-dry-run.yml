name: Deploy Dry Run

on:
  pull_request:
    branches: [master]
    paths:
      - 'frontend/**'
      - 'supabase/**'
      - '.github/workflows/deploy*.yml'

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  validate-backend:
    name: Validate Backend Deployment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Supabase configuration
        id: check-config
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ] || [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::warning::Supabase secrets not configured. Skipping dry run validation."
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Set up Supabase CLI
        if: steps.check-config.outputs.configured == 'true'
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validate Supabase connection
        if: steps.check-config.outputs.configured == 'true'
        run: |
          echo "Testing Supabase project connectivity..."
          if ! supabase link --project-ref "$SUPABASE_PROJECT_REF" 2>&1; then
            echo "::error::Failed to connect to Supabase project"
            echo "::notice::Check that SUPABASE_ACCESS_TOKEN and SUPABASE_PROJECT_REF secrets are correct"
            exit 1
          fi
          echo "Supabase connection successful"

      - name: Check for migrations
        if: steps.check-config.outputs.configured == 'true'
        id: check-migrations
        run: |
          if [ ! -d "supabase/migrations" ]; then
            echo "has_migrations=false" >> $GITHUB_OUTPUT
            echo "No migrations directory found"
          elif ls supabase/migrations/*.sql 1>/dev/null 2>&1; then
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "Found migrations to validate"
          else
            echo "has_migrations=false" >> $GITHUB_OUTPUT
            echo "No SQL migrations found"
          fi

      - name: Validate migrations (dry run)
        if: steps.check-config.outputs.configured == 'true' && steps.check-migrations.outputs.has_migrations == 'true'
        run: |
          echo "Validating database migrations..."
          # Use --dry-run flag if available, otherwise just check syntax
          if supabase db push --dry-run 2>/dev/null; then
            echo "Migrations validated successfully"
          else
            # Fallback: just verify migrations are parseable SQL
            echo "Checking migration file syntax..."
            for file in supabase/migrations/*.sql; do
              if [ -f "$file" ]; then
                echo "  Validating: $(basename "$file")"
              fi
            done
            echo "Migration files present and readable"
          fi

      - name: Check for Edge Functions
        if: steps.check-config.outputs.configured == 'true'
        id: check-functions
        run: |
          if find supabase/functions -mindepth 1 -maxdepth 1 -type d 2>/dev/null | grep -q .; then
            echo "has_functions=true" >> $GITHUB_OUTPUT
          else
            echo "has_functions=false" >> $GITHUB_OUTPUT
            echo "No Edge Functions found"
          fi

      - name: Validate Edge Functions (type check)
        if: steps.check-config.outputs.configured == 'true' && steps.check-functions.outputs.has_functions == 'true'
        run: |
          echo "Validating Edge Functions..."
          shopt -s nullglob
          for func_dir in supabase/functions/*/; do
            func_name=$(basename "$func_dir")
            if [ "$func_name" = "_shared" ]; then
              continue
            fi
            echo "  Checking: $func_name"
            # Check that index.ts exists
            if [ ! -f "$func_dir/index.ts" ]; then
              echo "::error::Edge Function '$func_name' missing index.ts"
              exit 1
            fi
          done
          echo "Edge Functions structure validated"

  validate-frontend:
    name: Validate Frontend Deployment
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    env:
      EXPO_PUBLIC_API_URL: ${{ secrets.SUPABASE_API_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Check Supabase configuration
        id: check-config
        working-directory: .
        run: |
          missing_secrets=""
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            missing_secrets="$missing_secrets SUPABASE_ACCESS_TOKEN"
          fi
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            missing_secrets="$missing_secrets SUPABASE_PROJECT_REF"
          fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            missing_secrets="$missing_secrets SUPABASE_SERVICE_ROLE_KEY"
          fi

          if [ -n "$missing_secrets" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::error::Missing required secrets:$missing_secrets"
            echo "::notice::Required secrets for deployment:"
            echo "  - SUPABASE_ACCESS_TOKEN: CLI access token from supabase.com/dashboard/account/tokens"
            echo "  - SUPABASE_PROJECT_REF: Project reference from Settings > General"
            echo "  - SUPABASE_SERVICE_ROLE_KEY: Service role key from Settings > API > service_role"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build static web app
        run: |
          echo "Building frontend for deployment validation..."
          npx expo export --platform web
          echo "Build successful"
          echo "Build output:"
          find dist -type f | wc -l | xargs -I{} echo "  {} files generated"

      - name: Set up Supabase CLI
        if: steps.check-config.outputs.configured == 'true'
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validate Storage API access
        if: steps.check-config.outputs.configured == 'true'
        working-directory: .
        run: |
          echo "Validating Supabase Storage API access..."
          STORAGE_API_URL="https://${SUPABASE_PROJECT_REF}.supabase.co/storage/v1"

          # Test that we can reach the Storage API with valid credentials
          set +e
          health_response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            "${STORAGE_API_URL}/bucket")
          health_status=$(echo "$health_response" | tail -n1)
          health_body=$(echo "$health_response" | sed '$d')
          set -e

          echo "Storage API response status: $health_status"

          if [ "$health_status" = "200" ]; then
            echo "✓ Storage API is accessible"
            echo "Existing buckets: $health_body"
          elif [ "$health_status" = "401" ] || [ "$health_status" = "403" ]; then
            echo "::error::Storage API authentication failed (HTTP $health_status)"
            echo "::notice::Verify SUPABASE_SERVICE_ROLE_KEY is correct"
            echo "::notice::Get the service_role key from: Settings > API > service_role"
            exit 1
          else
            echo "::error::Storage API unreachable (HTTP $health_status)"
            echo "::notice::Response: $health_body"
            exit 1
          fi

          # Check if bucket exists
          echo "Checking if 'website' bucket exists..."
          set +e
          bucket_response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            "${STORAGE_API_URL}/bucket/website")
          bucket_status=$(echo "$bucket_response" | tail -n1)
          set -e

          if [ "$bucket_status" = "200" ]; then
            echo "✓ Bucket 'website' exists"
            bucket_exists=true
          else
            echo "::notice::Bucket 'website' does not exist yet (will be created during deployment)"
            bucket_exists=false
          fi

      - name: Validate bucket creation capability
        if: steps.check-config.outputs.configured == 'true'
        working-directory: .
        run: |
          STORAGE_API_URL="https://${SUPABASE_PROJECT_REF}.supabase.co/storage/v1"

          # Create a temporary test bucket to verify we have creation permissions
          TEST_BUCKET="dry-run-test-$(date +%s)"
          echo "Testing bucket creation capability with temporary bucket: $TEST_BUCKET"

          set +e
          create_response=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"id\": \"$TEST_BUCKET\", \"name\": \"$TEST_BUCKET\", \"public\": false}" \
            "${STORAGE_API_URL}/bucket")
          create_status=$(echo "$create_response" | tail -n1)
          create_body=$(echo "$create_response" | sed '$d')
          set -e

          if [ "$create_status" = "200" ] || [ "$create_status" = "201" ]; then
            echo "✓ Bucket creation test passed"

            # Clean up test bucket
            echo "Cleaning up test bucket..."
            curl -s -X DELETE \
              -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
              -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
              "${STORAGE_API_URL}/bucket/$TEST_BUCKET" > /dev/null 2>&1 || true
            echo "✓ Test bucket cleaned up"
          else
            echo "::error::Bucket creation test failed (HTTP $create_status)"
            echo "::notice::Response: $create_body"
            echo "::notice::This means deployment WILL FAIL. Fix the issue before merging."
            echo "::notice::Common causes:"
            echo "  - SUPABASE_SERVICE_ROLE_KEY lacks storage permissions"
            echo "  - Storage service is unavailable"
            exit 1
          fi

      - name: Validate upload capability
        if: steps.check-config.outputs.configured == 'true'
        working-directory: .
        run: |
          STORAGE_API_URL="https://${SUPABASE_PROJECT_REF}.supabase.co/storage/v1"

          # Check if website bucket exists for upload test
          set +e
          bucket_response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            "${STORAGE_API_URL}/bucket/website")
          bucket_status=$(echo "$bucket_response" | tail -n1)
          set -e

          if [ "$bucket_status" = "200" ]; then
            echo "Testing upload capability to 'website' bucket..."

            # Create test file
            TEST_FILE="/tmp/dry-run-test-$(date +%s).txt"
            TEST_PATH=".dry-run-test/validate-$(date +%s).txt"
            echo "dry-run-validation-$(date)" > "$TEST_FILE"

            # Upload test file
            set +e
            upload_response=$(curl -s -w "\n%{http_code}" \
              -X POST \
              -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
              -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
              -F "file=@$TEST_FILE" \
              "${STORAGE_API_URL}/object/website/$TEST_PATH")
            upload_status=$(echo "$upload_response" | tail -n1)
            upload_body=$(echo "$upload_response" | sed '$d')
            set -e

            if [ "$upload_status" = "200" ] || [ "$upload_status" = "201" ]; then
              echo "✓ Upload test passed"

              # Clean up test file
              curl -s -X DELETE \
                -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
                -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
                "${STORAGE_API_URL}/object/website/$TEST_PATH" > /dev/null 2>&1 || true
              echo "✓ Test file cleaned up"
            else
              echo "::error::Upload test failed (HTTP $upload_status)"
              echo "::notice::Response: $upload_body"
              echo "::notice::This means deployment WILL FAIL. Fix the issue before merging."
              exit 1
            fi

            rm -f "$TEST_FILE"
          else
            echo "::notice::Bucket 'website' doesn't exist - skipping upload test"
            echo "Bucket will be created during deployment, and bucket creation was verified above"
          fi

      - name: Report validation results
        run: |
          echo ""
          echo "=========================================="
          echo "  DEPLOYMENT DRY RUN COMPLETED"
          echo "=========================================="
          echo ""
          echo "Frontend Build:"
          echo "  ✓ Build successful"
          file_count=$(find dist -type f | wc -l)
          echo "  ✓ Files ready for upload: $file_count"
          echo ""
          if [ "${{ steps.check-config.outputs.configured }}" = "true" ]; then
            echo "Storage Validation:"
            echo "  ✓ Storage API accessible"
            echo "  ✓ Bucket creation capability verified"
            echo "  ✓ Credentials valid"
            echo ""
            echo "=========================================="
            echo "  ✓ DEPLOYMENT WILL SUCCEED"
            echo "=========================================="
          else
            echo "Storage Validation: SKIPPED"
            echo "  ⚠ Missing secrets - deployment will fail"
            echo ""
            echo "=========================================="
            echo "  ⚠ FIX SECRETS BEFORE MERGING"
            echo "=========================================="
          fi
